tombstone_top_dir=/blackbox/system/tombstones

found_latest_tb_file_index()
{
    if [ ! -f $tombstone_top_dir/index ]; then
        echo 1 > $tombstone_top_dir/index
        tb_index=0
    else
        tb_index=`cat $tombstone_top_dir/index`
        let next_index=$tb_index+1
        if [ $next_index -gt 8 ]; then
            next_index=0
        fi
        echo $next_index > $tombstone_top_dir/index
    fi
}

calc_tombstones_dirname()
{
	mkdir -p $tombstone_top_dir
	cd $tombstone_top_dir
	ls > /tmp/tombstone_files
	file_num=`busybox wc -l /tmp/tombstone_files | busybox awk '{ print $1}'`
	if [ $file_num == 0 ];then
		ts_dir=$tombstone_top_dir/tombstone_0
	else
		busybox sort -g /tmp/tombstone_files > /tmp/tombstone_files_sort
		cur_num=`busybox tail /tmp/tombstone_files_sort -n 1`
		rm_dir=$(($cur_num-16))	# keep latest 8 dump files
		if [ $rm_file -ge 0 ];then
			rm -rf $tombstone_top_dir/$rm_dir
			sync
		fi
		let cur_num+=1
		ts_dir=$tombstone_top_dir/tombstone_$cur_num
	fi

	echo $ts_dir
	mkdir -p $ts_dir
}

check_tombstone()
{
    file_num=`busybox ls /data/tombstones | busybox wc -l`
    found_tombstones=0
    if [ file_num -ne 0 ]; then
        # has tombstones, copy to saved dir
        # check whether the tombstones is generated by dji_
        for file in /data/tombstones/*
        do
            echo "tombstone file is $file"
            busybox cat $file | busybox head -n 10 | busybox grep dji_
            if [ $? -eq 0 ]; then
                echo "found tombstones"
                found_tombstones=1
            fi
        done
        echo "check all the tombstone file done. found_tombstones=$found_tombstones"

        if [ $found_tombstones -eq 1 ]; then
            found_latest_tb_file_index
            echo "tb_index=$tb_index"
            mkdir -p $tombstone_top_dir/tombstone_$tb_index
            for file in /data/tombstones/*
            do
                echo "check $file for dji service tombstone"
                busybox cat $file | busybox head -n 10 | busybox grep dji_
                if [ $? -eq 0 ]; then
                    cp $file $tombstone_top_dir/tombstone_$tb_index/
                fi
            done
            sync
        fi
        rm -rf /data/tombstones/*
    else
        echo "found no tombstones"
    fi
}

main()
{
    mkdir -p $tombstone_top_dir
    check_tombstone
}
main